## パーソナライズ学習 要件定義・機能設計（MVP）

本ドキュメントは、Issue #26「パーソナライズ学習の要件・機能設計」で議論している内容をもとに、MVPで実装するパーソナライズ学習機能の**要件定義**および**機能設計**を整理したものである。

関連:
- GitHub Issue #26 「パーソナライズ学習の要件・機能設計」
- `docs/requirements/functional.md` パーソナライズ学習（MVPスコープ）

---

## 1. 概要

ユーザールールで定義されている「①パーソナライズ学習」を、MVPの範囲で以下のように具体化する。

- アプリ初回起動時に、ユーザーの英語レベルを判定するテスト（リスニング＆スピーキング）を実施する。
- テスト結果（全20問の合計点）をもとに、ユーザーを「初級・中級・上級」のいずれかに自動的に分類する。
- 分類されたレベルに応じて、ユーザーに提示するシナリオをフィルタリングし、そのユーザーに最適なレベルのシナリオのみを表示する。

将来的には、学習履歴に基づく高度な推薦や苦手分野分析なども行うが、MVPでは**初回テスト＋レベル別シナリオ表示**にフォーカスする。

---

## 2. スコープ

### 2.1 MVPで実装する範囲

- 初回レベル判定テスト
  - アプリ初回起動時（ユーザー登録完了直後）にテストを実施。
  - リスニング問題およびスピーキング問題を含む **全20問** を出題。
  - 問題内容は既存シナリオ（各プロンプト）をベースに作成する。
- レベル判定
  - 各問題にスコア（点数）を設定し、ユーザーの回答結果に応じて加点。
  - **全20問の得点を単純に合計したスコア**を、そのユーザーのレベル判定に用いる。
  - 合計スコアを閾値で区切り、「初級」「中級」「上級」のいずれかに自動分類する。
- レベル別シナリオ表示
  - 各シナリオにレベル属性（初級・中級・上級）を付与。
  - ユーザーの現在レベルと一致するシナリオのみ、シナリオ選択画面に表示する。
- データ永続化
  - ユーザープロファイルに、レベル情報とテスト結果（リスニング・スピーキング別スコア、および合計スコア）を保存する。

### 2.2 MVPのスコープ外（将来拡張）

以下は将来的に検討する機能であり、今回のMVPでは**設計のみ、あるいは「将来拡張」として位置付け**る。

- 苦手分野の特定と重点学習
  - 文法・語彙・発音など分野別の弱点分析
  - 苦手分野に特化したシナリオや練習問題の自動推薦
- 学習進捗の可視化
  - 学習時間や完了セッション数、改善度のグラフ表示
  - 学習ストリーク、目標達成度の可視化
- 学習履歴に基づく高度なシナリオ推薦
  - 直近の学習履歴から、次に学ぶべきシナリオを自動推薦
- 復習タイミングの最適化
  - 忘却曲線などをベースにした自動復習スケジュール

レベル振り分けロジックも、当面は**「初回テスト20問の合計点のみ」**で判定し、それ以上の高度な適応ロジックは後続タスクで検討する。

---

## 3. 要件定義

### 3.1 機能要件（Functional Requirements）

1. 初回レベル判定テスト起動
   - ユーザー登録完了直後、またはアプリ初回起動時にレベル判定テスト画面を表示すること。
   - 既にレベルが確定済みのユーザーは、レベル判定テストをスキップできること。

2. テスト構成
   - テストは以下2種類のセクションで構成されること。
     - リスニングテスト
     - スピーキングテスト
   - 合計で20問を出題すること。
     - 問題は既存学習シナリオ（各プロンプト）をベースとして設計すること。

3. スコアリング
   - 各問題に配点を設定し、ユーザーの回答に基づいてスコアを算出できること。
   - スコア算出結果として、以下を保持すること。
     - リスニングテストのスコア合計
     - スピーキングテストのスコア合計
     - 上記2つを合算した総合スコア（total）

4. レベル判定
   - 総合スコアを入力として、ユーザーを以下3レベルのいずれかに分類すること。
     - 初級
     - 中級
     - 上級
   - レベル判定ロジックは「総合スコアに対する閾値判定」とし、詳細な閾値は後続タスクで調整可能であること。

5. シナリオのレベル属性
   - 各シナリオ（プロンプト）に、以下のいずれかのレベル属性を持たせること。
     - 初級
     - 中級
     - 上級

6. レベル別シナリオ表示
   - シナリオ選択画面では、ユーザーの現在レベルと一致するシナリオのみ表示すること。
     - 例: 初級ユーザーには「初級」のシナリオのみ表示。
   - 将来拡張として、複数レベルの混在表示やおすすめ枠などを追加する余地を残す。

7. データ永続化
   - ユーザープロファイルに、以下の情報を保存すること。
     - 現在の学習レベル（初級・中級・上級）
     - 初回レベル判定テストのスコア（listening / speaking / total）
   - 保存されたレベル・スコアは、後続の高度なパーソナライズ機能の入力として利用できること。

8. 再テスト（将来検討）
   - MVPでは必須ではないが、将来的にユーザーが任意タイミングでレベル再判定テストを実施できるようにすることを前提に、API・データモデルを設計する。

### 3.2 非機能要件（Non-Functional Requirements）

- テストフローはモバイル環境でもストレスなく実行できるUI/UXであること。
- レベル判定にかかる処理時間は、ユーザー体感で即時〜数秒以内とする（バックエンド計算は軽量なロジックとする）。
- ユーザーレベルとテストスコアはプライバシーに配慮して取り扱い、認証済みユーザーのみがアクセスできること。

---

## 4. 機能設計

### 4.1 ユーザープロファイル設計（概念レベル）

ユーザープロファイルには、少なくとも以下の項目を持たせる。

- `level` : string
  - 値: `"beginner" | "intermediate" | "advanced"`（初級・中級・上級）
- `test_score_listening` : number
  - 初回レベル判定テストにおけるリスニングのスコア
- `test_score_speaking` : number
  - 初回レベル判定テストにおけるスピーキングのスコア
- `test_score_total` : number
  - `test_score_listening + test_score_speaking`
- `level_decided_at` : datetime（任意）
  - レベルが確定した日時

### 4.2 シナリオモデル設計（概念レベル）

各シナリオには以下の属性を追加・保持する。

- `scenario_id` : number / string
- `title` : string
- `category` : string（例: 旅行 / ビジネス / 日常会話）
- `level` : string
  - 値: `"beginner" | "intermediate" | "advanced"`
- 既存のプロンプト内容（会話用のシステムプロンプトなど）

### 4.3 パーソナライズアルゴリズム（MVP）

MVPでのアルゴリズムは、下記のような**シンプルなルールベース**とする。

1. 初回テスト完了時:
   - `test_score_listening` と `test_score_speaking` を計算。
   - `test_score_total = listening + speaking` を算出。
   - `test_score_total` を閾値テーブルに当てはめて `level` を決定。
2. シナリオ一覧取得時:
   - ログインユーザーの `level` を取得。
   - `scenario.level == user.level` のシナリオのみを返却。

将来的な拡張として、以下を視野に入れる。

- 学習履歴（正答率・発話品質など）からレベルを再計算・更新する。
- カテゴリ別の得意・不得意を加味した推薦ロジック。

---

## 5. UI/UX設計（概要）

### 5.1 初回テスト画面

- ユーザー登録完了後、最初に表示されるフローとして実装。
- ステップ構成の例:
  1. テスト概要説明画面
  2. リスニングセクション（複数問）
  3. スピーキングセクション（複数問）
  4. 結果表示画面（レベル: 初級/中級/上級 と簡単なメッセージ）

### 5.2 シナリオ選択画面

- ユーザーの現在レベルを画面上部などに表示（例: 「あなたのレベル: 中級」）。
- レベルに応じてフィルタ済みのシナリオ一覧のみを表示。
- 将来的には、「他のレベルを見る」「おすすめ」タブなどの拡張余地を残す。

---

## 6. 技術設計（概要）

### 6.1 想定API（例）

1. 初回テスト問題取得API
   - `GET /api/personalization/level-test/questions`
   - 役割: 初回テスト用の20問（リスニング・スピーキング混在 or セクション別）を取得。

2. テスト回答送信API
   - `POST /api/personalization/level-test/submit`
   - 入力: ユーザーの回答一覧。
   - 出力: `test_score_listening`, `test_score_speaking`, `test_score_total`, `level`。
   - 副作用: 上記結果をユーザープロファイルに保存。

3. ユーザープロファイル取得API
   - `GET /api/users/me/profile`
   - レベルやテスト結果を含む。

4. レベル別シナリオ一覧API
   - `GET /api/scenarios?level=current` など
   - ログインユーザーの `level` を用いてシナリオをフィルタして返却。

### 6.2 データベース

- 既存のユーザーテーブルに、レベル関連カラムを追加する想定。
- シナリオテーブル（または定義ファイル）に、`level` カラム/属性を追加。

なお、シナリオは今後も継続的に追加・拡張されていくことを前提とし、
- コード側にシナリオ内容やレベルをベタ書きせず、データベース（または設定ファイル）で管理すること  
- レベル・カテゴリ・タグなどのメタデータを持たせ、**新しいシナリオやカテゴリが増えても API やサービス層のコード変更を最小限にできる設計**とすること  
を技術設計上の方針とする。

---

## 7. 受け入れ条件（MVP）

- 初回テスト20問のフローを通じて、ユーザーが自分のレベル（初級・中級・上級）を知ることができる。
- テスト結果に基づいて、ユーザープロファイルにレベルおよびスコアが保存される。
- シナリオ選択画面において、ユーザーのレベルに合ったシナリオのみが表示される。
- 苦手分野分析・進捗ダッシュボード・高度な推薦など、MVPスコープ外の機能は、本ドキュメントおよびIssue #26上で「将来拡張」と明確に区別されている。


