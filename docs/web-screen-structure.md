## Web版画面構成ドキュメント（Next.js）

本ドキュメントは、Web版（`apps/web`）の画面構成と画面遷移の概要をまとめたものです。Flutter版への移植や仕様確認の際のリファレンスとして利用します。

---

## 1. 画面一覧（URLベース）

- **`/login` ログイン画面**
  - コンポーネント: `src/app/login/page.tsx`
  - 概要:
    - AI English Trainer へのログインを行うエントリ画面。
    - 「ログインして開始する」ボタン（`LoginButton`）を押下すると、外部認証フロー（Auth0 等）に遷移。
    - ログイン済みの場合は自動的に `/` へリダイレクト。

- **`/` ホーム（シナリオ選択画面）**
  - コンポーネント: `src/app/page.tsx`
  - 概要:
    - ログイン済みユーザー向けのメイン画面。
    - `/auth/me` で現在のユーザー情報を取得し、`placement_completed_at` が未設定の場合は `/placement` に強制リダイレクト。
    - レベル判定が完了している場合は、`ScenarioPage` を表示し、シナリオ一覧から会話セッションを開始できる。

- **`/placement` レベル判定テスト画面**
  - コンポーネント: `src/app/(app)/placement/page.tsx`
  - 概要:
    - 自己評価ベースのレベル判定テスト（20問）を提供。
    - `/placement/questions` で設問を取得し、0〜5の自己スコアを各問に対して入力。
    - Listening タイプの問題は TTS による読み上げ（`playTextWithTts`）が可能。
    - 「レベルを判定してシナリオ選択へ進む」ボタンで `/placement/submit` を呼び出し、完了後に `/` へ遷移。
    - 既に `placement_completed_at` がある場合は `/` にリダイレクト（再受験は `/settings` から）。

- **`/sessions/[sessionId]` 会話セッション画面**
  - コンポーネント: `src/app/(app)/sessions/[sessionId]/page.tsx`
  - 概要:
    - 選択したシナリオに対する 1 セッション分の会話を行うメイン画面。
    - `useSessionConversation` フックでセッション状態（ターン一覧、進捗、ゴール達成状況など）を管理。
    - 左側: 会話ログ（ユーザー発話・AI応答・フィードバック・改善例文）。
    - 下部: テキスト入力欄＋送信ボタン、音声録音コンポーネント（`AudioRecorder`）による STT 入力。
    - 右側: セッション情報パネル（シナリオ名、難易度、ラウンド進捗、ゴール達成率など）と延長・終了ボタン。
    - ラウンドが規定数に達したり、バックエンドから自動終了フラグを受け取ると、`ExtendModal` を表示し「+3ラウンド延長」「セッション終了」「復習へ」といった選択を促す。

- **`/summary` セッション結果サマリ画面**
  - コンポーネント: `src/app/(app)/summary/page.tsx`
  - 概要:
    - クエリパラメータ `sessionId` を受け取り、そのセッションの結果を表示。
    - `/sessions/{id}/end` の結果に相当するサマリ情報を `fetchSessionSummary` で取得し、以下を表示:
      - シナリオ名、難易度、モード
      - 完了ラウンド数
      - ゴール達成率（`goalsAchieved/goalsTotal`）
      - セッションID
    - 「改善トップ3フレーズ」として、復習対象となる重要フレーズとその説明をカード形式で提示。
    - 次回の復習予定日や、現在の復習アイテム数（`fetchReviewItems`）を表示。
    - 「新しいセッションを開始する」ボタンで `/` へ、「復習ページへ」ボタンで `/review` へ遷移。

- **`/review` 復習画面**
  - コンポーネント: `src/app/review/page.tsx`
  - 概要:
    - 「復習タイム」として、前日などに保存された復習フレーズをクイズ形式で提示。
    - 実際の復習ロジックは `ReviewQuiz` コンポーネントに実装されており、`/reviews/next` や `/reviews/{id}/complete` と連携。
    - 復習結果に応じて次回の出題タイミングが更新される。

- **`/settings` ユーザー設定画面**
  - コンポーネント: `src/app/(app)/settings/page.tsx`
  - 概要:
    - `/auth/me` の情報を元に、ユーザー名・メールアドレス・現在のレベル・スコア・最終レベル判定日を表示。
    - 「レベル判定テストを受け直す」ボタンで `/placement` に遷移し、再テストを実施可能。

- **`/callback` 認証コールバック画面**
  - コンポーネント: `src/app/callback/page.tsx`
  - 概要:
    - 認証プロバイダ（Auth0 等）からのリダイレクト先。
    - トークン処理・セッション確立後に `/` へ遷移する想定（詳細は `use-auth` 周辺の実装に依存）。

---

## 2. 画面遷移フロー（ハッピーパス）

ここでは、典型的なユーザーの学習フローに沿って画面遷移をテキストでまとめます。

### 2.1 初回利用時（レベル未判定ユーザー）

1. **`/login`**
   - ユーザーは「ログインして開始する」ボタンをクリック。
   - 外部認証 → 成功後に `/` へ遷移。

2. **`/` （ホーム）**
   - `/auth/me` の結果で `placement_completed_at` が `null` の場合、自動的に `/placement` に `router.replace` される。
   - この時点ではシナリオ選択は表示されない。

3. **`/placement` レベル判定テスト**
   - 20問の自己評価テストに回答。
   - Listening 問題は TTS ボタンで問題文を再生可能。
   - 全問スコア入力後、「レベルを判定してシナリオ選択へ進む」を押すと `/placement/submit` が呼ばれ、完了時に `/` へ `router.push`。

4. **`/` シナリオ選択**
   - `placement_level` に応じて表示シナリオがフィルタされる（初級 / 中級 / 上級）。
   - ユーザーは興味のあるシナリオカードをクリックし、ラウンド数や難易度設定を行ったうえでセッション開始。
   - バックエンドの `/sessions/start` が呼ばれ、新規セッションIDが払い出される。
   - フロントエンドでは作成された `sessionId` に基づき、`/sessions/[sessionId]` に遷移。

5. **`/sessions/[sessionId]` 会話セッション**
   - 画面上部: シナリオ名とラウンド進捗。
   - 左ペイン: 会話ログ（ユーザー発話 → AI応答 → フィードバック＋改善例文）。
   - 下部: テキスト入力欄と送信ボタン、音声録音ボタン（STT → テキスト入力反映）。
   - 右ペイン: セッション情報（難易度、モード、ゴール達成率、残り時間目安など）と「+3ラウンド延長」「セッションを終了する」ボタン。
   - ラウンド上限に到達、またはバックエンドから `should_end_session` が返却された場合:
     - `ExtendModal` を表示し、「+3ラウンド延長」または「セッションを終了する」/「復習する」を選択。

6. **セッション終了アクション**
   - 「セッションを終了する」を選んだ場合:
     - `/sessions/{id}/end` を呼び出し、完了後は `/` または `/summary?sessionId=...` へ遷移（実装側のコールバックで制御）。
   - 「復習する」を選んだ場合:
     - `/sessions/{id}/end` を呼び出し、完了後に `/summary?sessionId=...` へ遷移。

7. **`/summary?sessionId=...` セッション結果サマリ**
   - セッションのメタ情報と、保存された「改善トップ3フレーズ」を確認。
   - 次回復習日や復習アイテム数も表示。
   - 「新しいセッションを開始する」で `/` へ戻り、別シナリオで再度セッション開始。
   - 「復習ページへ」で `/review` に遷移。

8. **`/review` 復習**
   - `ReviewQuiz` コンポーネントで、復習対象のフレーズをクイズ形式で提示。
   - 回答結果に応じて `/reviews/{id}/complete` が呼ばれ、スケジューラが更新される。
   - 復習完了後はホームや他の画面に遷移（実装の UX に依存）。

### 2.2 2回目以降の利用時（レベル判定済みユーザー）

1. **`/login`**
   - ログイン成功後に `/` へ遷移。

2. **`/`**
   - `/auth/me` の結果で `placement_completed_at` が存在する場合、即座にシナリオ選択画面を表示。
   - 以降のフローは「4. シナリオ選択」以降と同様。

3. **`/settings` からの再レベル判定**
   - ヘッダーやユーザーメニューから `/settings` に遷移。
   - 「レベル判定テストを受け直す」ボタン押下で `/placement` へ遷移し、再度レベル判定フローを実施。

---

## 3. 画面遷移の要点（Flutter移植時の参考）

- **ログイン制御**
  - `AuthGuard` と `use-auth` により、「認証必須画面（`/`, `/placement`, `/sessions/*`, `/summary`, `/review`, `/settings`）」と「非必須画面（`/login`, `/callback`）」が明確に分かれている。
  - Flutter 版では `go_router` の `redirect` と Riverpod の認証状態を組み合わせて同じ挙動を再現する。

- **レベル判定の分岐**
  - ホーム (`/`) 表示前に `/auth/me` を必ず確認し、`placement_completed_at` の有無で `/placement` への強制遷移を行うロジックが重要。
  - Flutter 版でも「ログイン直後は必ず placement 完了状態を確認 → 未完なら PlacementScreen へ」という制御が必要。

- **セッションIDベースの画面構成**
  - セッション開始時に `/sessions/start` で ID を取得し、その ID を URL（`/sessions/[sessionId]`）および API 呼び出しの両方で利用している。
  - SessionScreen 相当の画面は「URLパラメータ／ルートパラメータからセッションIDを受け取り、そのIDを使って状態管理する」という構成を踏襲すると分かりやすい。

- **終了後のフロー**
  - セッション終了時には必ず `/sessions/{id}/end` を叩き、その結果を Summary 画面のデータとして利用する、という一方向のフローになっている。
  - 「終了 → サマリ → 復習」という流れを一連の UX として保つことが、学習体験の一貫性に重要。

---

## 4. まとめ

- Web版は、**ログイン → レベル判定（初回のみ） → シナリオ選択 → 会話セッション → サマリ → 復習** という一本道の学習フローを中心に設計されている。
- 各画面は Next.js のルーティング（`/`, `/login`, `/placement`, `/sessions/[sessionId]`, `/summary`, `/review`, `/settings`）に対応しており、API 契約と密接に結びついている。
- Flutter 版では、この画面構成と遷移ロジックをそのまま踏襲することで、Web とモバイル間で一貫した学習体験を提供できる。  

本ドキュメントは、必要に応じてスクリーンショットやコンポーネントレベルの説明を追加して拡張していくことを想定しています。


