日付: 2025-09-28

今日の取り組み:
- フロントエンド/バックエンドの起動手順とデバッグ方法（uvicorn の --reload や VS Code 設定、curl による API テスト）を整理。
- Auth0/JWT の認証フローを確認し、開発モードでの dev ユーザー自動作成を検証。シナリオ ID とカテゴリのマッピング、既存 DB データの内容も照会。
- SQLAlchemy Enum が原因の LookupError/ProgrammingError を解決するため、DB カラムを String 化し、Enum ↔ 文字列の相互変換をサービス層・スキーマで徹底。Pydantic v2 に合わせ Literal 型へ変更。
- SessionStartResponse / SessionStatusResponse のバリデーションエラーを解消し、レスポンスを文字列で統一。Session 延長・終了処理も想定どおり動作することを確認。
- DATABASE_URL を絶対パス化して常に apps/api/app.db を参照するように修正し、ルート直下に誤って生成された app.db を削除。

日付: 2025-09-29

今日の取り組み:
- 復習用のレビューサービスと API（`GET /api/v1/reviews/next`, `POST /api/v1/reviews/{id}/complete`）を実装し、復習アイテムの取得・完了・再スケジュール処理を追加。
- セッション終了レスポンスにシナリオ名や難易度・モードを含めるよう拡張し、保存されたトップフレーズを復習システムへ連携できるように調整。
- フロントエンドに復習ページ（`/review`）とクイズ UI を追加し、復習結果送信・再読み込み・セッション画面への導線を実装。
- UI コンポーネント（ボタンのバリアントなど）と型定義を更新し、新規フローに対応。

日付: 2025-10-01

今日の取り組み:
- セッション終了APIを冪等化し、既に終了済みのセッションIDに対しても保存済みサマリーを返せるように修正。
- フロントエンドの会話フックで終了処理の多重送信を防ぐガードを追加し、ユーザー操作の安定性を向上。

日付: 2025-10-02

今日の取り組み:
- Issue #20「サマリー画面API連携」を完了。TODOコメントを削除し、React Queryを使用したAPI連携を実装。
- セッション終了結果の取得・表示、トップ3フレーズの表示、復習予定の表示機能を実装。
- ローディング状態とエラーハンドリングを追加し、型安全性を向上。
- Issue #7「フロントエンド認証UI実装」を完了。Auth0認証UIを実装し、ログイン/ログアウト機能を追加。
- 認証コンポーネント（LoginButton, LogoutButton, AuthStatus, AuthGuard）を作成。
- 認証状態管理（React Context）、認証フロー、認証ガードを実装。
- バックエンドに認証エンドポイント（/auth/login, /auth/callback, /auth/logout）を追加。
- モック認証システムを実装し、開発環境での認証フローを完成。
- APIクライアントの認証エラーハンドリングを改善し、401エラー時の自動ログアウトを実装。

課題点:
- 認証URLの重複問題（/api/v1/api/v1/auth/login）を解決するため、環境変数設定の見直しが必要。
- 本格的なAuth0統合のため、実際のAuth0ドメインとクライアント設定の実装が必要。
- モック認証から本格認証への移行時のトークン検証ロジックの実装が必要。


日付: 2025-10-07

今日の取り組み:
- Issue #22「音声認識機能実装」を完了。Whisper API を使ったバックエンドの `/api/v1/audio/transcribe` を新設し、音声ファイル検証・エラーハンドリングを整備。
- フロントエンドに `use-audio-recording` フックと `AudioRecorder` コンポーネントを追加し、音声録音・文字起こし UI を会話画面へ統合。
- FormData 対応や API クライアントの改善、`Session` ライブラリ更新を行い、音声認識フロー全体を完成。
- `.env` テンプレート（`infra/env/backend.env.example`, `infra/env/frontend.env.example`）を用意し、README に環境変数セットアップ手順を追記。
- バックエンド設定を環境変数対応に整理し、`OPENAI_API_KEY` を外部設定に切り替え。
- `/auth/token` でアプリ署名の JWT を発行するよう修正し、`get_current_user` が自前トークンと Auth0 トークンを切り分けて検証できるよう改修。これによりセッション開始時の 401 エラーを解消。

課題点:
- 本番運用を見据えた Google OAuth 実トークン検証（Auth0 非依存）の整備とテストが未完。
- Whisper API 利用時の費用監視やレート制御、フロントの録音対応ブラウザ範囲のドキュメント化が必要。

日付: 2025-10-08

今日の取り組み:
- バックエンドから Auth0 依存コードを除去して自前 JWT のみに統一し、フロントとドキュメントの環境変数も Google OAuth 用に整理。
- 会話ターン処理で難易度 Enum を正規化して AI サービスに渡すよう修正し、500 エラーの原因になっていた型不一致を解消。
- VS Code デバッグ構成の作業ディレクトリを `apps/api` に合わせ、uvicorn が意図したディレクトリから起動するよう修正。
- 音声認識は Google Cloud Speech-to-Text 前提に変更し、バックエンド／フロント／会話統合／インフラ整備のそれぞれに対応する Issue 計画を作成。

日付: 2025-10-25

今日の取り組み:
- シナリオ選択による自動難易度設定機能を実装。シナリオ選択時に自動的に難易度が決定されるよう変更し、フロントエンドから難易度選択UIを削除。
- 会話終了判定機能を完全実装。AIがユーザーの発話から終了意図を検知し、自動的にセッションを終了する機能を追加。
  - バックエンド: ConversationResponse/TurnResponseにshould_end_sessionフラグ追加、全プロンプトに[END_SESSION]マーカー指示追加、AI応答パーサー修正、SessionServiceに自動終了処理実装
  - フロントエンド: 型定義更新、自動終了処理（2秒遅延）、UI表示改善
- バックエンドとフロントエンドを同時起動できるスクリプト（scripts/start_dev.sh）を作成。
- Issue #23「会話終了判定機能の実装」とIssue #24「サマリページの改善文をユーザー発話ベースに修正」を作成し、実装内容を詳細に記録。

課題点:
- サマリページの改善文表示がAI応答ベースになっているため、ユーザー発話ベースへの修正が必要。
- 会話終了判定がうまく動作していない。現在の実装では、AIがユーザーの発話から終了意図を適切に検知できていない。様々なAIモデル（GPT-4、GPT-4o、Claude等）での動作検証と、プロンプト設計の改善が必要。誤検知防止の検証も未完了。

日付: 2025-11-1
- 今日の取り組み。
 - "https://api.openai.com/v1/responses"は最新のOpenAIのエンドポイント
    旧バージョンは"https://api.openai.com/v1/chat/completions"
    返ってくるデータ構造も全然違う。
 - systempromptの作り方も違う。v1ではuserとsystem_promptの作りを別にできたがv2ではuser_inputに全て含める必要がある

日付: 2025-11-02

今日の取り組み:
- OpenAI APIエンドポイントを`/v1/responses`に移行し、新しいAPI形式に対応。
- リクエストパラメータを`input`フィールドにJSON文字列として送信する形式に変更（`messages`配列をJSON文字列化）。
- レスポンス解析を新しいAPI形式に対応。`output`配列から`content`を抽出し、`type`が`output_text`または`text`のアイテムからテキストを取得するように修正。
- タイムアウトを12秒から30秒に延長し、APIレスポンス待機時間を改善。
- サマリーページの「新しいセッションを開始する」ボタンを有効化。`useRouter`を使用してシナリオ選択ページ（`/`）にリダイレクトするように修正。

課題点:
- `/v1/responses`エンドポイントのリクエスト形式が正しく動作するかの検証が必要（400エラーやタイムアウトエラーの解決が必要）。
- 新しいAPI形式でのレスポンス構造の完全な理解と適切なエラーハンドリングの実装が必要。


日付: 2025-11-3
今日の取り組み
- フロント側の終了判定ロジックを深掘り。
 - hasEnded→フロント側の終了判定を検知。
 - endMutation.isPending → バックエンドにセッション終了リクエストを送信の状態を管理。
 - statusQuery.data?.isActive →　セッション状態を管理。
- 終了判定ロジックを検証し、終了検知時にラウンド完遂時に同様にモーダルが自動的に出て終了するように変更。


 課題
- モーダルにセッション終了と復習ボタンの二つがあるが、両方とも押してもページ遷移しない。

日付: 2025-11-20
今日の取り組み:
- セッション開始時の初期メッセージ機能を実装。`SessionStatusResponse` に `initial_ai_message` を追加し、会話画面の最初にAIからの導入メッセージを自動表示できるようにした。
- 初期メッセージに対してはフィードバックや改善例文のUIを表示しないように修正し、通常ラウンドとの差別化を行った。
- 各シナリオに学習ゴールと紐づくキーフレーズ（動詞句・熟語）を3つずつ追加し、シナリオ詳細モーダルと会話中の「学習ゴール」モーダルの両方で確認できるようにした。
- パーソナライズ学習のためのレベル判定テスト機能を実装。ユーザーに20問の自己評価テストを提示する `/placement/questions` と、合計点からレベル（beginner/intermediate/advanced）を決定・保存する `/placement/submit` を追加した。
- `users` テーブルとユーザースキーマに `placement_level` / `placement_score` / `placement_completed_at` を追加し、レベル判定結果を永続化。SQLiteに対してはALTER TABLEでカラムを追加して既存DBを移行した。
- フロントエンドに `/placement` ページを追加し、初回ログイン時は必ずレベルテストにリダイレクト、完了後はシナリオ選択画面に進むフローを実装した。以後は `/auth/me` の `placement_completed_at` を見てテストをスキップする。
- シナリオ選択画面でユーザーレベルに応じたフィルタリングを導入（beginner→初級のみ、intermediate→初級＋中級、advanced→全て表示）し、現在のレベルをUIに表示するようにした。
- 実装途中で発生した `/auth/me` のレスポンス検証エラー（EnumとLiteralの不整合）や、`\"use client\"` のタイポ、`users.placement_level` カラム未作成エラーを特定・修正し、バックエンドテスト（pytest apps/api）も全てパスすることを確認した。
- Google Cloud Text-to-Speech を利用するため、バックエンドに `GoogleTTSProvider` を追加し、`POST /api/v1/audio/tts` エンドポイントからテキストをMP3音声として返せるようにした。
- フロントエンドに `playTextWithTts` ヘルパーを実装し、会話画面のAI応答とレベル判定テストのListening問題それぞれに読み上げボタン（🔊）を追加、ワンクリックで英語音声を再生できるようにした。
- TTS呼び出し時のエラーハンドリング（API呼び出し失敗時は400/500を返し、フロント側では簡易メッセージ表示）を追加し、音声再生ができない場合もUI的に破綻しないようにした。

日付: 2025-11-21
今日の取り組み:
- セッション画面のAI応答について、ユーザーのクリック不要で自動的に音声が再生されるようにTTS連携を改善（初期メッセージを含む全AI応答が対象）。
- `useSessionConversation` フックに最新ターンを監視するロジックを追加し、確定済みAI応答のみを `playTextWithTts` で一度だけ自動再生するよう制御（pending中メッセージやプレースホルダーは除外）。
- 既存の会話行コンポーネントから🔊ボタンと再生状態管理を削除し、自動再生前提のシンプルなUIにリファクタリング。
- ブラウザの自動再生ブロックやネットワークエラー発生時でも会話UIが壊れないように、TTSエラーは `console.warn` ログのみにとどめる形でエラーハンドリングを実装。

日付: 2025-11-22
今日の取り組み:
- Issue #29「セッション達成率判定と表示機能」を実装。学習ゴールの達成状況を各ターンで逐次更新し、リアルタイムにユーザーへフィードバックできる機能を追加。
- バックエンドにシナリオID→learningGoalsのマッピングを追加（`SCENARIO_GOALS`）し、各シナリオの学習目標を定義。
- OpenAI APIによる達成率判定処理を実装。会話履歴とゴール一覧をプロンプトに渡し、各ゴールの達成状況を0/1のフラグ配列として取得。
- 各ターン処理（`POST /sessions/{id}/turn`）に達成率判定を組み込み、前回値とのORマージで単調増加（0→1のみ、揺れ戻りなし）を保証する制御を実装。
- セッションターンレスポンスと終了レスポンスに `goals_total` / `goals_achieved` / `goals_status` フィールドを追加し、Pydanticスキーマと TypeScript 型定義を拡張。
- フロントエンドの会話画面ヘッダーに達成率バッジ（例: `2/3`）を常時表示し、サマリ画面でも最終達成率を表示するUIを実装。
- OpenAI呼び出し失敗時のフォールバック処理を追加し、達成率判定エラーでもセッションが継続できるようエラーハンドリングを強化。
- ゴール未定義シナリオでも `0/0` として適切に処理し、UIが自然に振る舞うよう実装（バッジ非表示）。

主な成果:
- MVPの4つの価値（①パーソナライズ学習 ②インタラクティブ会話 ③即時フィードバック ④徹底した復習）のうち、①パーソナライズ学習をさらに強化。
- ユーザーが学習の進捗をリアルタイムに把握できるようになり、学習意欲の向上が期待できる。
- AIによる柔軟な達成判定により、定型的な文言マッチングではなく、文脈に応じた適切な評価が可能に。
